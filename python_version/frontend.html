<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MNOA ‚Äì Medication Name Overlap Analyzer</title>
<style>
  /* ===== Theme / layout =====
     - Colors, shadows, spacing, sizes
     - Used across the page
  */
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#f6f9ff; --card:#fff; --ink:#111827; --muted:#6b7280;
    --border:#e5e7eb; --primary:#2563eb; --ghost:rgba(37,99,235,.16);
    --radius:20px; --shadow:0 1px 2px rgba(0,0,0,.05), 0 10px 30px rgba(0,0,0,.07);
    --gap:24px;
    --ta-h:480px;  /* big twin height (left + right textareas) */
    --label-h:28px; /* label line height */
  }
  body{
    margin:0; padding:32px 40px; background:var(--bg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--ink);
  }
  .wrap{max-width:1640px; margin:0 auto}

  /* Header row: icon + title */
  .hdr{display:flex; align-items:center; gap:12px; margin-bottom:var(--gap)}
  .hdr h1{margin:0; font-size:28px; font-weight:800}
  .hdr small{color:var(--muted); font-weight:600}

  /* 4-col main row:
     1) input field
     2) button (center)
     3) alphabetized field
     4) sidebar pills (collapsed)
  */
  .row{
    display:grid;
    grid-template-columns: 1fr 84px 360px; 
    gap:var(--gap);
    align-items:start;
    min-width:1240px; 
  }

  /* Field block: label + textarea */
  .field{display:flex; flex-direction:column}
  .label{
    font-weight:700; margin:0 0 8px 2px; line-height:1;
    min-height:var(--label-h); display:flex; align-items:center;
  }
  .textarea{
    width:100%; height:var(--ta-h); resize:vertical;
    padding:14px 16px; font-size:15px; line-height:1.45;
    border:1px solid var(--border); border-radius:var(--radius); background:#fff; box-shadow:var(--shadow);
    outline:none;
  }
  .textarea:focus{border-color:var(--primary); box-shadow:0 0 0 3px var(--ghost), var(--shadow)}

  /* CTA column: keeps the button centered between the two big textareas */
  .cta{position:relative; height:calc(var(--label-h) + var(--ta-h)); display:block}
  .btn{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:60px; height:60px; border-radius:50%; border:none; cursor:pointer;
    background:var(--primary); color:#fff; font-weight:800; font-size:20px;
    display:grid; place-items:center; box-shadow:var(--shadow);
  }
  .btn:active{transform:translate(-50%,-50%) scale(.98)}

  /* Sidebar pills (collapsed by default) */
  .side{
    display:flex; flex-direction:column; justify-content:center; gap:20px;
    height:calc(var(--label-h) + var(--ta-h)); /* same height as the big fields */
  }
  .pill{
    display:block; width:100%;
    border:1px solid var(--border); background:#fff; border-radius:999px; box-shadow:var(--shadow);
    overflow:hidden; /* keeps rounded look when open */
  }
  .pill .hd{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 18px; cursor:pointer; font-weight:700;
  }
  .pill .hint{color:var(--muted); font-size:12px; white-space:nowrap}
  .pill .content{
    max-height:0; overflow:hidden; transition:max-height .25s ease;
    border-top:1px solid var(--border); background:#fff;
  }
  .pill.open{border-radius:var(--radius)} /* round corners when open */
  .pill.open .content{max-height:var(--pill-max, 600px); overflow:visible}
  
  /* Scroll area inside some pills:
     - rounds text, kp table, overlaps
  */
  #p-rounds .content .inner,
  #p-kp .content .inner,
  #p-overlaps .content .inner {
      max-height: 250px;
      overflow-y: auto;
      padding: 12px 18px;
  }

  #p-alpha .content .inner {
  max-height: var(--ta-h);
  overflow-y: auto;
  padding: 12px 18px;
}

  /* Table + code text */
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:9px 8px; border-bottom:1px solid #f1f5f9; text-align:left}
  th{font-weight:700}
  pre{font-family:Consolas,Menlo,monospace; font-size:13px; white-space:pre-wrap; margin:0}
  
  /* Sticky table header (kp table) */
  .sticky-header {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 10;
  }
  
  /* Visual highlight helpers (added/removed in JS) */
  .data-highlight {
    border-color: var(--primary) !important;
    box-shadow: 0 0 0 3px var(--ghost), var(--shadow) !important;
    transition: all 0.5s ease;
  }
  .accordion-highlight {
    border-color: var(--primary) !important;
    box-shadow: 0 0 0 3px var(--ghost), var(--shadow) !important;
    transition: all 0.5s ease;
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Top header: turtle icon + app title -->
    <div class="hdr">
      <img src="https://cdn-icons-png.flaticon.com/512/6789/6789501.png" alt="" width="40" height="40" />
      <h1>MNOA <small>- Medication Name Overlap Analyzer</small></h1>
    </div>

    <!-- Main 4-column row -->
    <div class="row">
      <!-- Left big field: user input -->
      <section class="field">
        <div class="label">Paste a list of medication names here‚Ä¶</div>
        <textarea id="medInput" class="textarea" placeholder="One medication per line‚Ä¶"></textarea>
      </section>

      <!-- Center: analyze button (calls submitNames) -->
      <div class="cta">
        <button class="btn" aria-label="Analyze" type="button" onclick="submitNames()">‚ñ∂</button>
      </div>

      <!-- Right big field: alphabetized result (read-only) -->
      <!-- <section class="field">
        <div class="label">Alphabetized List for Analysis</div>
        <textarea id="alphaBox" class="textarea" placeholder="Results will appear here after Analyze" readonly></textarea>
      </section> -->

      <!-- Far right: small boxes (pills), collapsed by default -->
      <aside class="side">
        <!-- Right big field: alphabetized result (collapsible pill, open by default) -->
        <div class="pill open" id="p-alpha">
          <div class="hd" onclick="toggleAccordion('p-alpha')">
            <span>Alphabetized List</span>
            <span class="hint">(click to collapse)</span>
          </div>
          <div class="content" style="--pill-max: var(--ta-h);">
            <div class="inner" style="padding:12px 18px;">
              <textarea
                id="alphaBox"
                class="textarea"
                placeholder="Results will appear here after Analyze"
                readonly
              ></textarea>
            </div>
          </div>
        </div>
  

        <!-- Overall stats -->
        <div class="pill" id="p-overall">
          <div class="hd" onclick="toggleAccordion('p-overall')">
            <span>üìä Overall List Stats</span>
            <span class="hint">(click to expand)</span>
          </div>
          <div class="content"><div class="inner" style="padding:12px 18px;">
            <div><strong>Number of med names provided = </strong><span id="stat-count">-</span> names</div>
            <div><strong>Number of med names analysed = </strong><span id="stat-overlap">-</span> characters</div>
            <div><strong>Raw Keystroke Power = </strong><span id="stat-kpraw">-</span> keystrokes</div>
            <div><strong>Keystroke Power Percent = </strong><span id="stat-kppercent">-</span> %</div>
          </div></div>
        </div>

        <!-- Rounds text (scrolls inside) -->
        <div class="pill" id="p-rounds">
          <div class="hd" onclick="toggleAccordion('p-rounds')">
            <span>üîÅ Round By Round Stats</span>
            <span class="hint">(click to expand)</span>
          </div>
          <div class="content"><div class="inner">
            <pre id="roundStats" style="white-space:pre-wrap;"></pre>
          </div></div>
        </div>

        <!-- KP table (sticky header + scroll inside) -->
        <div class="pill" id="p-kp">
          <div class="hd" onclick="toggleAccordion('p-kp')">
            <span>‚å®Ô∏è Keystroke Power by Round</span>
            <span class="hint">(click to expand)</span>
          </div>
          <div class="content"><div class="inner">
              <table id="kprawTable" style="width:100%; border-collapse:collapse; font-size:14px;">
                <thead class="sticky-header">
                  <tr>
                    <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px 4px;">Round</th>
                    <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px 4px;">KPraw</th>
                    <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px 4px;">%KP</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
          </div></div>
        </div>

        <!-- Overlaps text (scrolls inside) -->
        <div class="pill" id="p-overlaps">
          <div class="hd" onclick="toggleAccordion('p-overlaps')">
            <span>üîé All Overlaps by Round</span>
            <span class="hint">(click to expand)</span>
          </div>
          <div class="content"><div class="inner">
            <div id="overlap-box" style="font-family:monospace; font-size:13px; white-space:pre-wrap;"></div>
          </div></div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Toggle one pill. Close other open pills.
    function toggleAccordion(accordionId) {
      const allAccordions = ['p-alpha', 'p-overall', 'p-rounds', 'p-kp', 'p-overlaps'];
      allAccordions.forEach(id => {
        const pill = document.getElementById(id);
        if (id !== accordionId && pill.classList.contains('open')) {
            pill.classList.remove('open');
        }
      });
      const accordion = document.getElementById(accordionId);
      accordion.classList.toggle('open');
    }

    // --- %KP helpers (EXACT original) ---
    // normalizePercent: accepts 0‚Äì1 or 0‚Äì100 and returns 0‚Äì100
    function normalizePercent(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return null;
      return n > 1 ? n : n * 100;
    }
    // fmtPct: prints percent with 2 decimals, or "‚Äì"
    function fmtPct(v){
      const p = normalizePercent(v);
      return p == null ? "‚Äì" : p.toFixed(2);
    }
    // --- end helpers ---
    
    // Button look based on input state
    function updateButtonState() {
      const textarea = document.getElementById("medInput");
      const button = document.querySelector(".btn");
      const hasContent = textarea.value.trim().length > 0;
      if (hasContent) {
        button.style.background = "var(--primary)";
        button.style.color = "white";
        button.style.cursor = "pointer";
      } else {
        button.style.background = "var(--border)";
        button.style.color = "var(--muted)";
        button.style.cursor = "not-allowed";
      }
    }

    // Run once ready: wire listeners for input -> button state
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById("medInput");
      textarea.addEventListener('input', updateButtonState);
      textarea.addEventListener('keyup', updateButtonState);
      textarea.addEventListener('paste', function() {
        setTimeout(updateButtonState, 10);
      });
      updateButtonState(); // set initial
    });

    // Add highlight while loading / updating
    function applyHighlights() {
      document.getElementById("medInput").classList.add("data-highlight");
      document.getElementById("alphaBox").classList.add("data-highlight");
      document.querySelectorAll(".pill").forEach(item => {
        item.classList.add("accordion-highlight");
      });
    }

    // Remove highlight after load
    function removeHighlights() {
      document.getElementById("medInput").classList.remove("data-highlight");
      document.getElementById("alphaBox").classList.remove("data-highlight");
      document.querySelectorAll(".pill").forEach(item => {
        item.classList.remove("accordion-highlight");
      });
    }

    // Main action: read input, call /disambiguate, fill all views
    async function submitNames(){
      const rawInput = document.getElementById("medInput").value;
      const names = rawInput.split("\n").map(n=>n.trim()).filter(n=>n.length>0);
      if (names.length === 0) {
        document.getElementById("alphaBox").value = "Please enter some medication names first.";
        return;
      }
      
      applyHighlights(); // show glow

      // Reset UI while loading
      document.getElementById("alphaBox").value = "Processing medication names...";
      document.getElementById("stat-count").innerText = "-";
      document.getElementById("stat-overlap").innerText = "-";
      document.getElementById("stat-kpraw").innerText = "-";
      document.getElementById("stat-kppercent").innerText = "-";
      document.getElementById("roundStats").innerText = "";
      document.querySelector('#kprawTable tbody').innerHTML = "";
      document.getElementById("overlap-box").innerText = "Processing...";

      try {
        // Send to backend
        const response = await fetch("/disambiguate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ names })
        });
        const result = await response.json();

        // Alphabetized list (right big field)
        if (result.cleaned_names && result.cleaned_names.length > 0) {
          document.getElementById("alphaBox").value = result.cleaned_names.join("\n");
        } else {
          document.getElementById("alphaBox").value = "No valid medication names found.";
        }

        // Top stats: count, kp sums, percent
        const totalNames = result.cleaned_names.length;
        const totalKpRaw = result.round_stats.reduce((sum, r) => sum + (Number(r.KPraw) || 0), 0);
        const totalChars = result.round_stats.reduce((sum, r) => sum + (Number(r.characters) || 0), 0);
        const weightedPercent = totalChars > 0 ? (totalKpRaw / totalChars) * 100 : 0;
        const lastRound = result.round_stats[result.round_stats.length - 1];

        document.getElementById("stat-count").innerText = totalNames;
        document.getElementById("stat-overlap").innerText = lastRound?.disambiguated_names ?? "";
        document.getElementById("stat-kpraw").innerText = totalKpRaw;
        document.getElementById("stat-kppercent").innerText = weightedPercent.toFixed(2);

        // Rounds text block
        document.getElementById("roundStats").innerText = result.round_stats
          .map(stat =>
            `Round ${stat.characters}:
- Characters: ${Array.isArray(stat.search_terms) ? stat.search_terms.join(", ") : stat.search_terms}
- Total Unresolved: ${stat.unresolved_items}
- Total Disambiguated: ${stat.disambiguated_names}
- KPraw: ${stat.KPraw}
- %KP: ${fmtPct(stat["%KP"])}%`
          )
          .join('\n\n');

        // KP table rows
        const kpTbody = document.querySelector('#kprawTable tbody');
        if (kpTbody) {
          kpTbody.innerHTML = '';
          result.round_stats.forEach(stat => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="padding:6px 4px; border-bottom:1px solid #f0f0f0;">${stat.characters}</td>
              <td style="padding:6px 4px; border-bottom:1px solid #f0f0f0;">${stat.KPraw}</td>
              <td style="padding:6px 4px; border-bottom:1px solid #f0f0f0;">${fmtPct(stat["%KP"])}%</td>
            `;
            kpTbody.appendChild(tr);
          });
        }
        
        // Overlaps (group by round)
        const overlapLogsByRound = {};
        result.prefix_logs.forEach(log => {
          const round = log.round;
          if (!overlapLogsByRound[round]) {
            overlapLogsByRound[round] = [];
          }
          if (log.unresolved) {
            overlapLogsByRound[round].push(`Prefix "${log.prefix}" matched multiple: ${log.unresolved}`);
          } else if (log.disambiguated) {
            overlapLogsByRound[round].push(`Prefix "${log.prefix}" resolved: ${log.disambiguated}`);
          }
        });

        let formattedOverlaps = "";
        for (const round of Object.keys(overlapLogsByRound)) {
          const entries = overlapLogsByRound[round]
            .map(entry => `Round ${round}: ${entry}`)
            .join("\n");
          formattedOverlaps += entries + "\n\n";
        }
        document.getElementById("overlap-box").innerText = formattedOverlaps.trim() || "‚úÖ No unresolved overlaps.";

      } catch (error) {
        // Error state
        document.getElementById("alphaBox").value = "‚ùå Error: " + error.message;
      } finally {
        // Remove glow after a short delay
        setTimeout(removeHighlights, 1000);
      }
    }
  </script>
</body>
</html>
