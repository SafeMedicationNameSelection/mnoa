<!--
MNOA Frontend ‚Äì Medication Name Overlap Analyzer Web UI
Description:
- Single-page frontend for uploading medication name list
- Submits input to backend API (/disambiguate) and receives disambiguation results
- Displays cleaned names, round-by-round disambiguation logs, and summary statistics
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MNOA ‚Äì Medication Name Overlap Analyzer</title>

  <!-- Styling block for layout, typography, UI boxes -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      padding: 0;
      background-color: #f9f9f9;
    }

    h1 {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    textarea {
      width: 100%;
      max-width: 600px;
      height: 160px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: vertical;
    }

    button {
      margin-top: 12px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: bold;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    .output-section {
      margin-top: 30px;
      background-color: #fff;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      max-width: 800px;
      overflow-x: auto;
    }

    pre {
      font-family: Consolas, monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    label {
      font-weight: bold;
    }
  </style>
</head>

<body>
  <!-- Page wrapper with flex layout and padding -->
  <div style="display: flex; flex-direction: column; align-items: center; padding: 20px;">

    <!-- Header with app title and turtle logo -->
    <div style="display: flex; align-items: center; margin-bottom: 30px;">
      <img src="https://cdn-icons-png.flaticon.com/512/6789/6789501.png" alt="turtle" width="50" style="margin-right: 15px;">
      <h1 style="font-size: 28px; margin: 0;">
        <strong>MNOA</strong> <span style="font-weight: normal;">Medication Name Overlap Analyzer</span>
      </h1>
    </div>

    <!-- Main layout: input | button | output -->
    <div style="display: flex; width: 100%; max-width: 1100px;">
      
      <!-- Left Panel: Input text area -->
      <div style="flex: 1; padding-right: 10px;">
        <textarea id="medInput" placeholder="Paste a list of medication names here ..." style="width: 100%; height: 300px; font-size: 14px; padding: 10px; border-radius: 6px; border: 1px solid #ccc;"></textarea>
      </div>

      <!-- Middle Panel: Action Button -->
      <div style="display: flex; align-items: center; justify-content: center; padding: 0 10px;">
        <button onclick="submitNames()" style="font-size: 30px; border: none; background: none; cursor: pointer;">‚ñ∂Ô∏è</button>
      </div>

      <!-- Right Panel: Outputs (wrapped in vertical stack) -->
      <div style="flex: 1; padding-left: 10px; display: flex; flex-direction: column; gap: 20px;">

        <!-- Box: Summary Statistics -->
        <div style="border: 1px solid #ccc; border-radius: 6px; padding: 15px; background-color: #fff;">
          <h3 style="margin-top: 0;">üìä Statistics</h3>
          <div style="font-size: 14px;">
            <p><strong>Number of med names provided = </strong><span id="stat-count">-</span> names</p>
            <p><strong>Number of med names analysed = </strong><span id="stat-overlap">-</span> characters</p>
            <p><strong>Raw Keystroke Power = </strong><span id="stat-kpraw">-</span> keystrokes</p>
            <p><strong>Keystroke Power Percent = </strong><span id="stat-kppercent">-</span> %</p>
          </div>
        </div>

        <!-- Box: Cleaned Names + Round Stats (side-by-side layout) -->
        <div style="display: flex; gap: 10px;">
          
          <!-- Cleaned Name List (alphabetical) -->
          <div id="cleanedNamesBox" style="flex: 1; border: 1px solid #ccc; padding: 10px; overflow-y: auto; max-height: 300px;">
            <h3>‚úÖ Alphabetically Cleaned Names</h3>
            <ul id="cleanedNamesList"></ul>
          </div>

          <!-- Round-by-Round Stats -->
          <div id="roundStatsBox" style="flex: 1; border: 1px solid #ccc; padding: 10px; overflow-y: auto; max-height: 300px;">
            <h3>üîÅ Round Statistics</h3>
            <pre id="roundStats" style="white-space: pre-wrap;"></pre>
          </div>
        </div>

        <!-- ‚úÖ NEW: KPraw Table (Round-by-Round) -->
        <div id="kprawBox" style="border: 1px solid #ccc; border-radius: 6px; padding: 15px; background-color: #fff;">
          <h3 style="margin-top: 0;">‚å®Ô∏è Keystroke Power by Round</h3>
          <table id="kprawTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr>
                <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 6px 4px;">Round</th>
                <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 6px 4px;">KPraw</th>
                <th style="text-align: left; border-bottom: 1px solid #ddd; padding: 6px 4px;">%KP</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Box: All Overlap Logs (Grouped by Round) -->
        <div style="border: 1px solid #ccc; border-radius: 6px; padding: 15px; background-color: #fff; height: 250px; overflow-y: auto;">
          <h3 style="margin-top: 0;">üîç All Overlaps</h3>
          <div id="overlap-box" style="font-family: monospace; font-size: 13px; white-space: pre-wrap;"></div>
        </div>

      </div>
    </div>

    <!-- JavaScript  -->
    <script>
      // --- %KP helpers ---
      // NOTE: The backend may send %KP either as a fraction (0‚Äì1) or as a percent (0‚Äì100).
      // normalizePercent() converts either form into a 0‚Äì100 percentage for display.
      function normalizePercent(v) {
        const n = Number(v);
        if (!Number.isFinite(n)) return null;
        return n > 1 ? n : n * 100; // if <=1 treat as ratio; if >1 assume already a percent
      }
      // fmtPct() returns a 2-decimal string for % display (or "‚Äì" if not a number).
      function fmtPct(v) {
        const p = normalizePercent(v);
        return p == null ? "‚Äì" : p.toFixed(2);
      }
      // --- end helpers ---

      /**
       * submitNames()
       * 1) Reads the textarea input and sends it to /disambiguate (POST).
       * 2) Receives JSON containing:
       *    - cleaned_names: array of preprocessed names
       *    - round_stats: array of rounds with fields like:
       *        characters          ‚Üí the prefix length examined in this round
       *        search_terms        ‚Üí the actual prefix(es) used this round
       *        unresolved_items    ‚Üí how many names remain unresolved after this round
       *        disambiguated_names ‚Üí how many names have been resolved cumulatively
       *        KPraw               ‚Üí "raw keystroke power" contributed by THIS round
       *        %KP                 ‚Üí per-round keystroke power percent (backend‚Äôs value)
       *    - prefix_logs: logs of unresolved/resolved prefixes by round
       * 3) Updates all UI panels (stats, cleaned list, per-round table, overlap logs).
       *
       * üîé KP metrics (as implemented here):
       *    ‚Ä¢ KPraw (top box): we compute the cumulative sum across ALL rounds,
       *      i.e., sum of stat.KPraw for every round.
       *    ‚Ä¢ Keystroke Power Percent (top box): we compute a cumulative % across ALL rounds
       *      as (sum(KPraw) / sum(characters)) √ó 100. This gives an overall efficiency for the run.
       *    ‚Ä¢ In the "Round Statistics" panel and the "KPraw table", we display each round‚Äôs KPraw and %KP.
       *      The %KP there is normalized for display via fmtPct(...) so it looks consistent (0‚Äì100%).
       */
      async function submitNames() {
        // 1) Collect and sanitize user input lines
        const rawInput = document.getElementById("medInput").value;
        const names = rawInput
          .split("\n")
          .map(n => n.trim())
          .filter(n => n.length > 0);

        // Show a simple loading state in the UI while we wait for the backend
        document.getElementById("stat-count").innerText = "Loading...";
        document.getElementById("stat-overlap").innerText = "";
        document.getElementById("stat-kpraw").innerText = "";
        document.getElementById("stat-kppercent").innerText = "";
        document.getElementById("overlap-box").innerText = "Processing...";

        try {
          // 2) POST to backend endpoint with the array of names
          const response = await fetch("/disambiguate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ names })
          });

          // 3) Parse backend JSON response
          const result = await response.json();

          // --- Round Statistics panel ---
          // For each round, we show characters, search terms, unresolved/resolved counts,
          // KPraw (this round), and %KP (this round, normalized for display).
          document.getElementById("roundStats").innerText = result.round_stats
            .map(stat =>
              `Round ${stat.characters}:\n- Characters: ${Array.isArray(stat.search_terms) ? stat.search_terms.join(", ") : stat.search_terms}\n- Total Unresolved: ${stat.unresolved_items}\n- Total Disambiguated: ${stat.disambiguated_names}\n- KPraw: ${stat.KPraw}\n- %KP: ${fmtPct(stat["%KP"])}%`
            )
            .join('\n\n');

          // --- Cleaned Names panel ---
          // Shows the preprocessed, alphabetized names exactly as returned by backend.
          const cleanedList = document.getElementById("cleanedNamesList");
          cleanedList.innerHTML = '';
          result.cleaned_names.forEach(name => {
            const li = document.createElement("li");
            li.textContent = name;
            cleanedList.appendChild(li);
          });

          // --- Top Summary Statistics ---
          // totalNames: count of cleaned names returned by backend
          const totalNames = result.cleaned_names.length;

          // Cumulative KP working (top box):
          // ‚Ä¢ totalKpRaw: sum of KPraw contributed by EACH round.
          // ‚Ä¢ totalChars: sum of the "characters" field across ALL rounds (the per-round
          //   denominator used to size the search space by prefix length).
          // ‚Ä¢ weightedPercent: overall %KP for the full run = (sum(KPraw) / sum(characters)) √ó 100.
          const totalKpRaw = result.round_stats.reduce((sum, r) => sum + (Number(r.KPraw) || 0), 0);
          const totalChars = result.round_stats.reduce((sum, r) => sum + (Number(r.characters) || 0), 0);
          const weightedPercent = totalChars > 0 ? (totalKpRaw / totalChars) * 100 : 0;

          // lastRound: we still read some fields (e.g., disambiguated_names) from the final entry
          const lastRound = result.round_stats[result.round_stats.length - 1];

          // Update the top stats box
          document.getElementById("stat-count").innerText = totalNames;
          // NOTE: "Number of med names analysed" displays lastRound.disambiguated_names as in your code.
          document.getElementById("stat-overlap").innerText = lastRound.disambiguated_names;
          // Raw Keystroke Power (top): cumulative across all rounds
          document.getElementById("stat-kpraw").innerText = totalKpRaw;
          // Keystroke Power Percent (top): cumulative across all rounds
          document.getElementById("stat-kppercent").innerText = weightedPercent.toFixed(2);

          // --- KPraw Table ---
          // For each round, show the round number (as "characters"), the KPraw of that round,
          // and that round‚Äôs %KP normalized for display.
          const kpTbody = document.querySelector('#kprawTable tbody');
          if (kpTbody) {
            kpTbody.innerHTML = '';
            result.round_stats.forEach(stat => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td style="padding: 6px 4px; border-bottom: 1px solid #f0f0f0;">${stat.characters}</td>
                <td style="padding: 6px 4px; border-bottom: 1px solid #f0f0f0;">${stat.KPraw}</td>
                <td style="padding: 6px 4px; border-bottom: 1px solid #f0f0f0;">${fmtPct(stat["%KP"])}%</td>
              `;
              kpTbody.appendChild(tr);
            });
          }

          // --- All Overlaps log ---
          // Group overlap messages by round for readability.
          const overlapLogsByRound = {};
          result.prefix_logs.forEach(log => {
            const round = log.round;
            if (!overlapLogsByRound[round]) {
              overlapLogsByRound[round] = [];
            }
            if (log.unresolved) {
              overlapLogsByRound[round].push(`Prefix "${log.prefix}" matched multiple: ${log.unresolved}`);
            } else if (log.disambiguated) {
              overlapLogsByRound[round].push(`Prefix "${log.prefix}" resolved: ${log.disambiguated}`);
            }
          });

          // Flatten grouped logs into a single preformatted text block
          let formattedOverlaps = "";
          for (const round of Object.keys(overlapLogsByRound)) {
            const entries = overlapLogsByRound[round]
              .map(entry => `Round ${round}: ${entry}`)
              .join("\n");
            formattedOverlaps += entries + "\n\n";
          }
          document.getElementById("overlap-box").innerText =
            formattedOverlaps.trim() || "‚úÖ No unresolved overlaps.";

        } catch (error) {
          // Any network/parse error gets surfaced in the overlaps panel
          document.getElementById("overlap-box").innerText = "‚ùå Error: " + error;
        }
      }
    </script>

  </div>
</body>
</html>
