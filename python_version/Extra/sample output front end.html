<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MNOA ‚Äì Medication Name Overlap Analyzer</title>
<style>
  /* ===== Theme / layout (unchanged) ===== */
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#f6f9ff; --card:#fff; --ink:#111827; --muted:#6b7280;
    --border:#e5e7eb; --primary:#2563eb; --ghost:rgba(37,99,235,.16);
    --radius:20px; --shadow:0 1px 2px rgba(0,0,0,.05), 0 10px 30px rgba(0,0,0,.07);
    --gap:24px;
    --ta-h:480px;  /* big twin height */
    --label-h:28px;
  }
  body{
    margin:0; padding:32px 40px; background:var(--bg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--ink);
  }
  .wrap{max-width:1640px; margin:0 auto}

  /* Header */
  .hdr{display:flex; align-items:center; gap:12px; margin-bottom:var(--gap)}
  .hdr h1{margin:0; font-size:28px; font-weight:800}
  .hdr small{color:var(--muted); font-weight:600}

  /* 4-col: input | button | alphabetized | sidebar */
  .row{
    display:grid;
    grid-template-columns: 1fr 84px 1fr 360px;
    gap:var(--gap);
    align-items:start;
    min-width:1240px;
  }

  .field{display:flex; flex-direction:column}
  .label{
    font-weight:700; margin:0 0 8px 2px; line-height:1;
    min-height:var(--label-h); display:flex; align-items:center;
  }
  .textarea{
    width:100%; height:var(--ta-h); resize:vertical;
    padding:14px 16px; font-size:15px; line-height:1.45;
    border:1px solid var(--border); border-radius:var(--radius); background:#fff; box-shadow:var(--shadow);
    outline:none;
  }
  .textarea:focus{border-color:var(--primary); box-shadow:0 0 0 3px var(--ghost), var(--shadow)}

  /* CTA */
  .cta{position:relative; height:calc(var(--label-h) + var(--ta-h)); display:block}
  .btn{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:60px; height:60px; border-radius:50%; border:none; cursor:pointer;
    background:var(--primary); color:#fff; font-weight:800; font-size:20px;
    display:grid; place-items:center; box-shadow:var(--shadow);
  }
  .btn:active{transform:translate(-50%,-50%) scale(.98)}

  /* Sidebar pills */
  .side{
    display:flex; flex-direction:column; justify-content:center; gap:20px;
    height:calc(var(--label-h) + var(--ta-h));
  }
  .pill{
    display:block; width:100%;
    border:1px solid var(--border); background:#fff; border-radius:999px; box-shadow:var(--shadow);
    overflow:hidden;
  }
  .pill .hd{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 18px; cursor:pointer; font-weight:700;
  }
  .pill .hint{color:var(--muted); font-size:12px; white-space:nowrap}
  .pill .content{
    max-height:0; overflow:hidden; transition:max-height .25s ease;
    border-top:1px solid var(--border); background:#fff;
  }
  .pill.open{border-radius:var(--radius)}
  .pill.open .content{max-height:var(--pill-max, 600px); overflow-y:auto}

  #p-rounds .content{ --pill-max: 320px; }
  #p-overlaps .content{ --pill-max: 320px; }

  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:9px 8px; border-bottom:1px solid #f1f5f9; text-align:left}
  th{font-weight:700}
  pre{font-family:Consolas,Menlo,monospace; font-size:13px; white-space:pre-wrap; margin:0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <img src="https://cdn-icons-png.flaticon.com/512/6789/6789501.png" alt="" width="30" height="30" />
      <h1>MNOA <small>Medication Name Overlap Analyzer</small></h1>
    </div>

    <div class="row">
      <!-- 1) Input -->
      <section class="field">
        <div class="label">Paste a list of medication names here‚Ä¶</div>
        <textarea id="medInput" class="textarea" placeholder="One medication per line‚Ä¶"></textarea>
      </section>

      <!-- 2) CTA -->
      <div class="cta">
        <button class="btn" aria-label="Analyze" type="button" onclick="submitNames()">‚ñ∂</button>
      </div>

      <!-- 3) Alphabetized -->
      <section class="field">
        <div class="label">Alphabetized List for Analysis</div>
        <textarea id="alphaBox" class="textarea" placeholder="Results will appear here after Analyze" readonly></textarea>
      </section>

      <!-- 4) Sidebar -->
      <aside class="side">
        <div class="pill" id="p-overall">
          <div class="hd" data-toggle>
            <span>üìä Overall List Stats</span>
            <span class="hint">(click to expand)</span>
          </div>
          <div class="content"><div class="inner" style="padding:12px 18px;">
            <div><strong>Number of med names provided = </strong><span id="stat-count">-</span> names</div>
            <div><strong>Number of med names analysed = </strong><span id="stat-overlap">-</span> characters</div>
            <div><strong>Raw Keystroke Power = </strong><span id="stat-kpraw">-</span> keystrokes</div>
            <div><strong>Keystroke Power Percent = </strong><span id="stat-kppercent">-</span> %</div>
          </div></div>
        </div>

        <div class="pill" id="p-rounds">
          <div class="hd" data-toggle>
            <span>üîÅ Round By Round Stats</span>
            <span class="hint">(click to expand)</span>
          </div>
          <div class="content"><div class="inner" style="padding:12px 18px;">
            <pre id="roundStats" style="white-space:pre-wrap;"></pre>
          </div></div>
        </div>

        <div class="pill" id="p-kp">
          <div class="hd" data-toggle>
            <span>‚å®Ô∏è Keystroke Power by Round</span>
            <span class="hint">(click to expand)</span>
          </div>
          <div class="content"><div class="inner" style="padding:12px 18px;">
            <table id="kprawTable" style="width:100%; border-collapse:collapse; font-size:14px;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px 4px;">Round</th>
                  <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px 4px;">KPraw</th>
                  <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px 4px;">%KP</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div></div>
        </div>

        <div class="pill" id="p-overlaps">
          <div class="hd" data-toggle>
            <span>üîé All Overlaps by Round</span>
            <span class="hint">(click to expand)</span>
          </div>
          <div class="content"><div class="inner" style="padding:12px 18px;">
            <div id="overlap-box" style="font-family:monospace; font-size:13px; white-space:pre-wrap;"></div>
          </div></div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Collapsible pills (UI only)
    document.querySelectorAll('.pill .hd').forEach(hd=>{
      hd.addEventListener('click', ()=>hd.closest('.pill').classList.toggle('open'));
    });

    // --- %KP helpers (EXACT original) ---
    function normalizePercent(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return null;
      return n > 1 ? n : n * 100; // if <=1 treat as ratio; if >1 already percent
    }
    function fmtPct(v){
      const p = normalizePercent(v);
      return p == null ? "‚Äì" : p.toFixed(2);
    }
    // --- end helpers ---

    async function submitNames(){
      // 1) Collect input
      const rawInput = document.getElementById("medInput").value;
      const names = rawInput.split("\n").map(n=>n.trim()).filter(n=>n.length>0);

      // Loading placeholders (match original behavior)
      document.getElementById("stat-count").innerText = "Loading...";
      document.getElementById("stat-overlap").innerText = "";
      document.getElementById("stat-kpraw").innerText = "";
      document.getElementById("stat-kppercent").innerText = "";
      document.getElementById("overlap-box").innerText = "Processing...";
      document.getElementById("roundStats").innerText = "";
      document.querySelector('#kprawTable tbody').innerHTML = "";
      document.getElementById("alphaBox").value = "";

      try{
        // 2) Call backend
        const response = await fetch("/disambiguate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ names })
        });
        const result = await response.json();

        // --- Round Statistics panel (EXACT text/fields) ---
        document.getElementById("roundStats").innerText = result.round_stats
          .map(stat =>
`Round ${stat.characters}:
- Characters: ${Array.isArray(stat.search_terms) ? stat.search_terms.join(", ") : stat.search_terms}
- Total Unresolved: ${stat.unresolved_items}
- Total Disambiguated: ${stat.disambiguated_names}
- KPraw: ${stat.KPraw}
- %KP: ${fmtPct(stat["%KP"])}%`
          )
          .join('\n\n');

        // --- Cleaned Names (render one per line in the big twin) ---
        const cleaned = Array.isArray(result.cleaned_names) ? result.cleaned_names : [];
        document.getElementById("alphaBox").value = cleaned.join('\n');

        // --- Top Summary Statistics (unchanged math) ---
        const totalKpRaw = result.round_stats.reduce((sum, r) => sum + (Number(r.KPraw) || 0), 0);
        const totalChars = result.round_stats.reduce((sum, r) => sum + (Number(r.characters) || 0), 0);
        const weightedPercent = totalChars > 0 ? (totalKpRaw / totalChars) * 100 : 0;
        const lastRound = result.round_stats[result.round_stats.length - 1];

        document.getElementById("stat-count").innerText = cleaned.length;
        document.getElementById("stat-overlap").innerText = lastRound?.disambiguated_names ?? "";
        document.getElementById("stat-kpraw").innerText = totalKpRaw;
        document.getElementById("stat-kppercent").innerText = weightedPercent.toFixed(2);

        // --- KPraw Table (EXACT original mapping) ---
        const kpTbody = document.querySelector('#kprawTable tbody');
        kpTbody.innerHTML = '';
        result.round_stats.forEach(stat => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding:6px 4px; border-bottom:1px solid #f0f0f0;">${stat.characters}</td>
            <td style="padding:6px 4px; border-bottom:1px solid #f0f0f0;">${stat.KPraw}</td>
            <td style="padding:6px 4px; border-bottom:1px solid #f0f0f0;">${fmtPct(stat["%KP"])}%</td>
          `;
          kpTbody.appendChild(tr);
        });

        // --- All Overlaps (grouped by round; EXACT original logic) ---
        const overlapLogsByRound = {};
        result.prefix_logs.forEach(log => {
          const round = log.round;
          if (!overlapLogsByRound[round]) {
            overlapLogsByRound[round] = [];
          }
          if (log.unresolved) {
            overlapLogsByRound[round].push(`Prefix "${log.prefix}" matched multiple: ${log.unresolved}`);
          } else if (log.disambiguated) {
            overlapLogsByRound[round].push(`Prefix "${log.prefix}" resolved: ${log.disambiguated}`);
          }
        });

        let formattedOverlaps = "";
        for (const round of Object.keys(overlapLogsByRound)) {
          const entries = overlapLogsByRound[round]
            .map(entry => `Round ${round}: ${entry}`)
            .join("\n");
          formattedOverlaps += entries + "\n\n";
        }
        document.getElementById("overlap-box").innerText =
          formattedOverlaps.trim() || "‚úÖ No unresolved overlaps.";

      } catch (error) {
        document.getElementById("overlap-box").innerText = "‚ùå Error: " + error;
      }
    }
  </script>
</body>
</html>
